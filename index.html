<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<!DOCTYPE html>
<html>
<head>
    <title>Nexus of Fates</title>
    <style>
     #eventContainer {
         position: relative;
         height: 500px;
         width: 100%;
     }
     .event {
         position: absolute;
         height: 50px;
         width: 50px;
         cursor: pointer;
     }

     #textArea {
         margin-top: 10px;
         padding: 20px;
         background-color: #f5f5f5;
         border: 1px solid #ccc;
         width: 50vw;
         position: absolute;
         left: 10px;
         top: 1050px;
     }
    </style>
</head>
<body>
    <h1>Welcome to the Nexus of Fates</h1>
    <div id="eventContainer"></div>
    <div id="textArea">Click a square to see the event description.</div>

    <script>

     const oscillatorTypes = ['square', 'sawtooth', 'triangle'];

     var squares = []; // This array will store the position of each square
     var minimumDistance = 50; // The minimum allowed distance between squares
     const audioContext = new (window.AudioContext || window.webkitAudioContext)();

     function playFrequency(frequency, soundProperties) {
         var audioContext = new (window.AudioContext || window.webkitAudioContext)();
         var oscillator = audioContext.createOscillator();
         var secondOscillator = audioContext.createOscillator(); // second oscillator
         var filter = audioContext.createBiquadFilter();
         var gainNode = audioContext.createGain();
         var gainNode2 = audioContext.createGain();

         // Use the sound properties stored with the square
         oscillator.type = soundProperties.oscillatorType;
         oscillator.detune.value = soundProperties.detuneValue; // detune oscillator

         secondOscillator.type = "sine";
         secondOscillator.detune.value = soundProperties.secondDetuneValue; // detune oscillator


         filter.type = "peaking";
         filter.frequency.value = soundProperties.filterFrequency;
         filter.Q.value = soundProperties.filterQ;
         gainNode.gain.value = soundProperties.gainValue; // adjust volume

         oscillator.frequency.value = frequency; // value in hertz
         secondOscillator.frequency.value = frequency; // same frequency as the first oscillator

         // Connect the oscillator through the filter to the destination
         oscillator.connect(filter);
         secondOscillator.connect(filter);
         filter.connect(audioContext.destination);
         // Connect both oscillators to the gain node
         oscillator.connect(gainNode);
         secondOscillator.connect(gainNode);
         gainNode.gain.value = 0;
         gainNode2.gain.value = 0.4;
         oscillator.start();
         secondOscillator.start();
         // Use the ADSR envelope parameters to change the gain over time
         gainNode.gain.linearRampToValueAtTime(soundProperties.gainValue, audioContext.currentTime + soundProperties.attackTime);
         gainNode.gain.linearRampToValueAtTime(soundProperties.gainValue * soundProperties.sustainLevel, audioContext.currentTime + soundProperties.attackTime + soundProperties.decayTime);

         // Stop the oscillator after a short period of time
         setTimeout(function() {
             // Begin the "release" part of the ADSR envelope
             gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + soundProperties.releaseTime);
             // Stop the oscillators when the release phase is done
             setTimeout(function() {
                 oscillator.stop();
                 secondOscillator.stop();
                 audioContext.close();
             }, soundProperties.releaseTime * 1000);
         }, 500);
     }

     function createSquare(hue, freq, description) {
         var div = document.createElement('div');
         var lightness = 50 + 30 - 30 *Math.random();
         var saturation = 100 - 30 *Math.random();

         div.style.backgroundColor = 'hsl(' + hue + ', ' + saturation + '%, ' + lightness + '%)';
         div.id = hue + saturation + lightness;
         div.className = 'event ' + hue;

         var position;
         do {
             position = {
                 left: Math.random() * (window.innerWidth/2 - 100),  // Random position in the window
                 top: Math.random() * (window.innerHeight/2 - 100) // Random position in the window
             };
         } while (!isValidPosition(position)); // Keep generating positions until we find a valid one

         squares.push(position); // Store the position of the new square
         // Randomly select an oscillator type for this square
         var oscillatorType = oscillatorTypes[Math.floor(Math.random() * oscillatorTypes.length)];

         // Randomly set some filter parameters for this square
         var filterFrequency = Math.random() * 2000 + 500;
         var filterQ = Math.random() * 10;
         // Random detuning
         var detuneValue = (Math.random() * 200) - 100; // -100 to +100 cents detune
         var secondDetuneValue = (Math.random() * 20) - 10; // -10 to +10 cents detune

         // Random ADSR envelope parameters
         var attackTime = Math.random() * 0.2; // 0 to 0.2 seconds
         var decayTime = Math.random() * 0.2; // 0 to 0.2 seconds
         var sustainLevel = Math.random() * 0.8 + 0.2; // 0.2 to 1
         var releaseTime = Math.random() * 0.5; // 0 to 0.5 seconds

         // Random gain
         var gainValue = Math.random() * 0.6 + 0.2; // 0.2 to 1 gain (volume)
         // Store the sound properties with the square
         div.soundProperties = {
             oscillatorType: oscillatorType,
             filterFrequency: filterFrequency,
             filterQ: filterQ,
             detuneValue: detuneValue,
             gainValue: gainValue,
             secondDetuneValue: secondDetuneValue,
             attackTime: attackTime,
             decayTime: decayTime,
             sustainLevel: sustainLevel,
             releaseTime: releaseTime
         };
         div.style.left = position.left + 'px';
         div.style.top = position.top + 'px';
         div.onclick = function() {
             document.getElementById('textArea').innerText = description;
             playFrequency(freq,div.soundProperties);  // plays the note A4
         };
         return div;
     }

     function isValidPosition(position) {
         for (var i = 0; i < squares.length; i++) {
             var square = squares[i];
             var dx = position.left - square.left;
             var dy = position.top - square.top;
             var distance = Math.sqrt(dx * dx + dy * dy);
             if (distance < minimumDistance) {
                 return false; // The position is too close to this square
             }
         }
         return true; // The position is not too close to any square
     }
     var events = {
         red: ["Emergence Event 1", "Emergence Event 2", "Emergence Event 3"],
         orange: ["Alliance Event 1", "Alliance Event 2", "Alliance Event 3"],
         yellow: ["Conflict Event 1", "Conflict Event 2", "Conflict Event 3"],
         green: ["Reflection Event 1", "Reflection Event 2", "Reflection Event 3"],
         blue: ["Revelation Event 1", "Revelation Event 2", "Revelation Event 3"],
         indigo: ["Liberation of Darkness Event 1", "Liberation of Darkness Event 2", "Liberation of Darkness Event 3"],
         violet: ["Sacrifice Event 1", "Sacrifice Event 2", "Sacrifice Event 3"],
     };

     var hues = {
         red: 0,
         orange: 30,
         yellow: 60,
         green: 120,
         blue: 240,
         indigo: 280,
         violet: 320
     };
     var frequency = {
         red: 261.63,
         orange: 293.66,
         yellow: 329.63,
         green: 349.23,
         blue: 392.00,
         indigo: 440,
         violet: 493.88
     };

     var eventContainer = document.getElementById('eventContainer');
     var description = document.getElementById('description');
     //Create the standard events
     Object.keys(hues).forEach(function(color) {
         var hue = hues[color];
         var freq = frequency[color];
         for(var i = 1; i <= 10; i++) {
             eventContainer.appendChild(createSquare(hue,freq,color));
         }
     });

    </script>
</body>
</html>
